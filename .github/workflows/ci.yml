name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-linux:
    name: Test on Linux
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          curl \
          pkg-config \
          libyajl-dev \
          libseccomp-dev \
          libcap-dev \
          git \
          ca-certificates \
          autoconf \
          automake \
          libtool \
          make \
          python3 \
          python3-pip \
          libsystemd-dev
    
    - name: Build and install crun (provides libcrun)
      run: |
        cd /tmp && \
        git clone --depth 1 https://github.com/containers/crun.git && \
        cd crun && \
        ./autogen.sh && \
        ./configure --enable-shared --prefix=/usr/local && \
        make -j$(nproc) && \
        sudo make install && \
        sudo ldconfig && \
        cd / && \
        rm -rf /tmp/crun
        
    - name: Set PKG_CONFIG_PATH
      run: |
        echo "PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:${PKG_CONFIG_PATH}" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=/usr/local/lib:${LD_LIBRARY_PATH}" >> $GITHUB_ENV
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Verify libcrun installation
      run: |
        pkg-config --exists libcrun && echo "libcrun found" || echo "libcrun not found"
        pkg-config --modversion libcrun || true
    
    - name: Build
      run: cargo build --workspace
    
    - name: Run tests
      run: cargo test --workspace
    
    - name: Build agent
      run: cargo build --bin libcrun-shim-agent
    
    - name: Run example (if libcrun available)
      run: |
        if pkg-config --exists libcrun; then
          cargo run --example basic_usage || echo "Example requires rootfs, skipping"
        else
          echo "libcrun not available, skipping example"
        fi

  test-macos:
    name: Test on macOS
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Build
      run: cargo build --workspace
    
    - name: Run tests
      run: cargo test --workspace
    
    - name: Build agent
      run: cargo build --bin libcrun-shim-agent

  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install clippy
      run: rustup component add clippy
    
    - name: Run clippy
      run: cargo clippy --workspace -- -D warnings
    
    - name: Check formatting
      run: cargo fmt --check

